# Proof of Skill (PoS) Terraform aws web cluster


This is on request from Ask Nicely as a skills test.  
Though the assignment is simple terraform script, this script is not really of value without being part of a deployment pipeline. On a senior level this pipeline needs to be placed in context to show the value of the script. 
So it has been decided to place the terraform script in a pipeline.  
Goals are:  
- Show the added value of a pipeline. 
- Create a PoC that can be used outside training exercises. 
- Trigger a discussion of value and business processes as a result of this PoS 
- Showcase ask nicely what modern technologies can deliver in a short time. 

Out of scope are:  
- Any type of normal corroboration with the team or customer to establish this adds value to them and / or the team. 
- Code reviews and pull requests as normal within a software development team.  
- Any type of terraform state persistence. All is local state. 
- Limited use of SCM backed terraform modules to keep all code together. 
- Security in IAM , restrictions only as stipulated in the assignment. 
- CI other than an bash pipeline.

Licence:  
This software is licensed, before use please assess this fits your business-case. 


The requested assignment, (original); 

```
Write a Terraform resource that launches:

- [check] A VPC. This should include a subnet, route table, and internet gateway.
- [check] An EC2 instance, running a web server that serves a page with the content of your choice. This can be an AWS Free Tier instance, and based off a free tier image.
- [check] An Application Load Balancer targeting the EC2 instance.

This task will require the use of Terraform and the AWS provider. Feel free to use other providers as you see fit.

We use Terraform version 0.11, but use whatever version you are comfortable with.

Make sure that you are running an appropriate `.gitignore` file that excludes your Terraform state. We recommend [https://github.com/github/gitignore/blob/master/Terraform.gitignore](https://github.com/github/gitignore/blob/master/Terraform.gitignore)

What are we looking for?

- [check] Resources should be contained within the VPC
- [check] EC2 instances should not be directly publicly accessible by HTTP/HTTPS (You should be able to access web server content via the Load Balancer.)
- [check] Resources should be well named, well structured and logically separated. It's good to have use of modules and input/output variables when appropriate.

Extra Tasks:

- [check] Ports available on Load Balancers and EC2 instances should be limited to only the necessary ports
- [check] It should be possible to adjust the number of EC2 instances by only changing a variable
 
How to submit your work?

- Commit your Terraform project as a Github repo.
- Include a README.md that explains the intended way of executing the terraform plan, and how to access the content of your web server(s).
- Send us a link to your Github repository for the Terraform project.
```

# Strategy 

This project is a proof of skill for the use as terraform as a Infra as Code example. All parts of this project will be coded (except this readme, the license file and the initial .gitignore file which were generated by github project creation. And the project-template folder that will hold the generation code for the rest of the project) so it should be completely reproducable from code. 

# Architecture 

Architecural decisions are placed in the docs/doc/adr folder in the form of [Architecture Decision Records](https://github.com/joelparkerhenderson/architecture_decision_record) 
# Implementation 

## Technology stack
**Primary technology**
- Terraform 0.12.13  

**Ancillary technology**
- Linux Gnome 3.34
- Bash 5.0 
- IntelliJ 2019.2.4  
- Ansible 2.9.0 
- [ADR-tools](https://github.com/npryce/adr-tools/releases/tag/3.0.0)  
- Packer 1.4.1
- [AWS-Vault](https://github.com/99designs/aws-vault)

## Prerequisites
- AWS account with admin rights 
- AWS key and secret to the admin account
- Configure the .aws/credentials file as we use this in the terraform script, create the `private` profile 
- Linux machine or VM 
- Installed the technology stack. 
- Internet connection (no proxy)
- Register yourself for use of the `ami-0f42adcde7bd302ce`AMI [here](aws-marketplace/CentOS 8 LEMP Stack - Linux Nginx MySQL/MariaDB PHP 7.2-4c9ced57-677c-4dff-b708-e91c27f3fd7b-ami-042144ca63e136136.4) 

## Flow 
The readme will continue with the flow as follows:
- Pre: Setup and project generation 
- CI : Source image creation 
- Provision : Infrastructure and deployment
- The pipeline, go with the flow

## TL;DR 
After installing and assuring the prerequisites. 
Go to the ci folder and run
```bash 
bash pipeline.sh 0.1.0 DEV
```
And follow the deployment, note that you can follow the commands in the pipeline file to see how the process is working. This pipeline can easily run from Jenkins, Concourse, Circle CI or other CD/CI environment. 




## Skeleton project generation. 
The start phase is the generation of the directory structure of the site. Projects should follow a standard pattern that makes automation over several projects easier.
This is from a template project, normally this would come from a template repo. For simplicity sake we have it integral in this project. 

Needs; Ansible, Bash

run as 

```bash 
cd project-template/
bash build-skeleton-project.sh

```

Produces : Standarized project to work from.   
Values: Reproducible, Standarized, Documented as code. 


## Build image with application 
This will create an AIM image that we use for the deployment of the app. 
Needs: Packer, bash 
In the CI folder it will build from the build-release.sh script as 
```bash
bash build-release.sh <version> 
# for instance
bash build-release.sh 0.1.0
```

Produces: An AIM image with the software backed in from a trusted template  
Values: Developers can work of a trusted image and deploy the same image to several environments. 

Note: The base image defined in the packer json script at `ci/website-builder.json` is : `ami-0f42adcde7bd302ce`. 

This is a image with php and fastcgi installed. Get a subscription at `aws-marketplace/CentOS 8 LEMP Stack - Linux Nginx MySQL/MariaDB PHP 7.2-4c9ced57-677c-4dff-b708-e91c27f3fd7b-ami-042144ca63e136136.4` (no costs except usage) 

## Run by Environment 
In the infra folder there are three definitions, `non-prod/dev`. `non-prod/uat`, and `prod`. 
For each of these environments there is a provision block assigning the account to run form, and a call to the terraform module in the terraform folder of the project.  
From each of the folders the terraform provision will work by: 

The `ami-0afc3beaf12bfacc6` is the value the build-release will have returned as the AMI. This will be different from here. 

Needs: Terraform

```bash
terraform init
terrafrorm plan -var "deploy_image_website=ami-0afc3beaf12bfacc6" -out env.plan
terraform apply env.plan
``` 

Produces: Infrastructure and the website running.  
Values: Guarantee of status of the platform. Platform as a service, Infrastructure as code

Deployment and infrastructure maintenance in one provision phase. Expandable over many environments.
On completion the terraform apply script returns the endpoint of the loadbalancer to see the application on. 

 

Note: This system tears down the autoscaler on a new deploy and creates a new one, causing a few minutes outage, there is way to have no outage by doing the instance replacement by hand in the autoscaler console on AWS or use AWS commandline. 


